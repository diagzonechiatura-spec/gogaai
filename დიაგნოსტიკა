import React, { useEffect, useMemo, useRef, useState } from "react";
import { motion } from "framer-motion";
import { Bot, Car, Cpu, BookOpen, Upload, Wrench, Key, Database, Gauge, Settings, Send, Trash2, CircuitBoard, Lock, Zap, FileText, Search, Sparkles, Info, PlusCircle, CloudUpload, CheckCircle2, XCircle, Shield, HelpCircle, ChevronRight } from "lucide-react";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Badge } from "@/components/ui/badge";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from "@/components/ui/dialog";
import { toast } from "sonner";

// ---------------------------------------------
// GogaAI â€” Mechanic Assistant MVP (client-side only)
// ---------------------------------------------
// Notes:
// - This is a front-end prototype. Replace `mockAnswer` with real API later.
// - Uses Tailwind + shadcn/ui. All data is stored in local component state.
// - Language: mostly Georgian (the user's preference), with some tech English where appropriate.

// --- Mock knowledge base entries (you can edit/expand) ---
const DEFAULT_KNOWLEDGE: KnowledgeItem[] = [
  {
    id: "k1",
    tag: "Mercedes W211",
    title: "Boost pressure too low â€” áƒ¡áƒ¬áƒ áƒáƒ¤áƒ˜ áƒ’áƒ–áƒáƒ›áƒ™áƒ•áƒšáƒ”áƒ•áƒ˜",
    body: `
áƒ’áƒáƒœáƒ˜áƒ®áƒ˜áƒšáƒ” áƒ¡áƒáƒ›áƒ“áƒáƒ‘áƒáƒšáƒáƒ áƒ•áƒáƒ™áƒ£áƒ£áƒ›-áƒ®áƒáƒ–áƒ”áƒ‘áƒ˜, N75/N18 áƒ¡áƒáƒšáƒ”áƒœáƒáƒ˜áƒ“áƒ˜áƒ¡ PWM, wastegate actuator-áƒ˜áƒ¡ áƒ—áƒáƒ•áƒ˜áƒ¡áƒ£áƒ¤áƒáƒšáƒ˜ áƒ¡áƒ•áƒšáƒ. LiveData-áƒ–áƒ” idle ~90-110 kPa, 2500 rpm-áƒ–áƒ” 120-140 kPa (áƒáƒ¢áƒ›áƒáƒ¡áƒ¤áƒ”áƒ áƒ£áƒšáƒ˜ +). If MAP < expected: 
1) áƒ°áƒ”áƒ áƒ›áƒ”áƒ¢áƒ£áƒšáƒáƒ‘áƒ (áƒ°áƒáƒ”áƒ áƒ˜áƒ¡ áƒ’áƒáƒŸáƒáƒœáƒ•áƒ), 
2) áƒ•áƒáƒ™áƒ£áƒ£áƒ›áƒ˜áƒ¡ áƒ“áƒáƒ‘áƒáƒšáƒ˜ áƒ¬áƒœáƒ”áƒ•áƒ, 
3) Actuator áƒ’áƒáƒ­áƒ”áƒ“áƒ˜áƒšáƒ˜, 
4) áƒ¡áƒ”áƒœáƒ¡áƒáƒ áƒ˜áƒ¡ áƒ™áƒáƒšáƒ˜áƒ‘áƒ áƒ˜/áƒ’áƒáƒ«áƒ•áƒ áƒ.
`
  },
  {
    id: "k2",
    tag: "Nissan Terrano",
    title: "áƒ“áƒ˜áƒ–áƒ”áƒšáƒ˜áƒ¡ áƒ¡áƒáƒ¢áƒ£áƒ›áƒ‘áƒ˜ áƒ°áƒáƒ”áƒ áƒ¡ áƒ˜áƒ­áƒ”áƒ áƒ¡ â€” áƒ‘áƒ£áƒ¨áƒ¢áƒ£áƒ™áƒ”áƒ‘áƒ˜áƒ¡ áƒ“áƒ˜áƒáƒ’áƒœáƒáƒ¡áƒ¢áƒ˜áƒ™áƒ",
    body: `
áƒ—áƒ£ áƒ’áƒáƒ›áƒ­áƒ•áƒ˜áƒ áƒ•áƒáƒšáƒ” áƒ¨áƒšáƒáƒœáƒ’áƒ¨áƒ˜ áƒ‘áƒ£áƒ¨áƒ¢áƒ£áƒ™áƒ”áƒ‘áƒ˜ áƒ©áƒáƒœáƒ¡ áƒ“áƒ áƒ›áƒ£áƒ¨áƒáƒáƒ‘áƒ áƒ£áƒªáƒ•áƒšáƒ”áƒšáƒ˜áƒ: áƒ¡áƒáƒ•áƒáƒ áƒáƒ£áƒ“áƒáƒ“ áƒ°áƒáƒ”áƒ áƒ˜ áƒ‘áƒ áƒ£áƒœáƒáƒ•áƒ¡ áƒ“áƒáƒ‘áƒáƒšáƒ˜ áƒ¬áƒœáƒ”áƒ•áƒ˜áƒ¡ áƒœáƒáƒ¬áƒ˜áƒšáƒ¨áƒ˜, áƒ›áƒáƒ’áƒ áƒáƒ› áƒ›áƒáƒ¦áƒáƒšáƒ˜ áƒ¬áƒœáƒ”áƒ•áƒ˜áƒ¡ áƒœáƒáƒ¬áƒ˜áƒšáƒ˜ áƒ›áƒ£áƒ¨áƒáƒáƒ‘áƒ¡ áƒœáƒáƒ›áƒ˜áƒœáƒáƒšáƒ£áƒ áƒáƒ“. áƒ¨áƒ”áƒáƒ›áƒáƒ¬áƒ›áƒ”: 
â€¢ áƒ¤áƒ˜áƒšáƒ¢áƒ áƒ˜áƒ¡ áƒ™áƒáƒ áƒáƒ£áƒ¡áƒ˜áƒ¡ áƒ áƒ”áƒ–áƒ˜áƒœáƒ˜/áƒáƒ áƒ’áƒ˜áƒœáƒ’áƒ˜ 
â€¢ áƒ¡áƒ¬áƒ áƒáƒ¤áƒ˜ áƒ™áƒáƒ•áƒ¨áƒ˜áƒ áƒ”áƒ‘áƒ˜áƒ¡ áƒ™áƒšáƒ˜áƒáƒ”áƒ‘áƒ˜ 
â€¢ áƒ£áƒ™áƒ£áƒ›áƒ“áƒ˜áƒœáƒáƒ áƒ” áƒ¡áƒáƒ áƒ¥áƒ•áƒ”áƒšáƒ˜ 
â€¢ áƒ®áƒ”áƒšáƒ˜áƒ¡ áƒ¢áƒ£áƒ›áƒ‘áƒ (primer) 
â€¢ fuel heater base áƒ‘áƒ–áƒáƒ áƒ”áƒ‘áƒ˜.
`
  },
  {
    id: "k3",
    tag: "Subaru Legacy 2011",
    title: "áƒ¡áƒáƒ‘áƒáƒ áƒ’áƒ£áƒšáƒ˜áƒ¡ áƒ¦áƒ˜áƒšáƒáƒ™áƒ˜ â€” áƒ™áƒ•áƒ”áƒ‘áƒ˜áƒ¡ áƒ¢áƒ áƒáƒ¡áƒ˜áƒ¡ áƒ¨áƒ”áƒ›áƒáƒ¬áƒ›áƒ”áƒ‘áƒ",
    body: `
áƒ›áƒ£áƒ“áƒ›áƒ˜áƒ•áƒ˜ + áƒ“áƒ - áƒ—áƒ£ áƒáƒ áƒ˜áƒ¡ áƒ¦áƒ˜áƒšáƒáƒ™áƒ—áƒáƒœ, áƒ›áƒáƒ’áƒ áƒáƒ› áƒ¡áƒ˜áƒ’áƒœáƒáƒšáƒ˜ áƒáƒ  áƒ‘áƒ áƒ£áƒœáƒ“áƒ”áƒ‘áƒ BCM-áƒ›áƒ“áƒ”: 
1) áƒ¦áƒ˜áƒšáƒáƒ™áƒ˜áƒ¡ áƒ¨áƒ˜áƒ“áƒ áƒ™áƒáƒœáƒ¢áƒáƒ¥áƒ¢áƒ˜ 
2) áƒ™áƒáƒœáƒ”áƒ¥áƒ¢áƒáƒ áƒ˜áƒ¡ áƒ™áƒáƒ áƒáƒ–áƒ˜áƒ 
3) BCM-áƒ¡áƒ—áƒáƒœ LIN/CAN áƒ®áƒáƒ–áƒ˜áƒ¡ áƒ¬áƒ§áƒ•áƒ”áƒ¢áƒ 
4) áƒ¥áƒáƒ áƒ®áƒœáƒ£áƒšáƒ˜ áƒ¤áƒ˜áƒ£áƒ–áƒ˜ trunk release-áƒ˜áƒ¡áƒ—áƒ•áƒ˜áƒ¡ áƒ®áƒ¨áƒ˜áƒ áƒáƒ“ áƒ¨áƒ”áƒ áƒ¬áƒ§áƒ›áƒ£áƒšáƒ˜áƒ body fuse-áƒ—áƒáƒœ (áƒ¡áƒ¥áƒ”áƒ›áƒ áƒœáƒáƒ®áƒ”).
`
  }
];

// --- DTC quick hints (editable) ---
const DTC_HINTS: Record<string, string> = {
  P0299: "Turbo/Supercharger underboost â€” áƒ•áƒáƒ™áƒ£áƒ£áƒ›áƒ˜, wastegate, áƒ’áƒáƒŸáƒáƒœáƒ•áƒ, MAP/MAP hose.",
  P0606: "ECU Processor fault â€” áƒ™áƒ•áƒ”áƒ‘áƒ/áƒ›áƒ˜áƒ¬áƒ, áƒ•áƒ˜áƒ‘áƒ áƒáƒªáƒ˜áƒ, firmware corruption, áƒ¡áƒ˜áƒœáƒ¯áƒ” EEPROM/Flash.",
  P0335: "Crankshaft position sensor â€” áƒ¡áƒ˜áƒ’áƒœáƒáƒšáƒ˜, áƒ”áƒ›áƒ˜áƒ¡áƒ¤áƒ”áƒ áƒ˜, wiring shield, reluctor gap.",
  U0100: "Lost comm with ECM/PCM â€” CAN-H/CAN-L, áƒ¢áƒ”áƒ áƒ›áƒ˜áƒœáƒáƒ¢áƒáƒ áƒ˜ 120Î©, áƒ™áƒ•áƒ”áƒ‘áƒ BCM/ECM." ,
};

// Types
type ChatMessage = { role: "user" | "assistant"; text: string; time: string };
interface KnowledgeItem { id: string; title: string; body: string; tag?: string }

// Utility
const now = () => new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
const uid = () => Math.random().toString(36).slice(2);

// Mock AI answerer â€” replace with your API call
function mockAnswer(query: string, kb: KnowledgeItem[]): string {
  const q = query.toLowerCase();
  // 1) DTC match
  const dtc = Object.keys(DTC_HINTS).find(code => q.includes(code.toLowerCase()));
  if (dtc) return `ğŸ’¡ DTC ${dtc}: ${DTC_HINTS[dtc]}\n\nâ¡ï¸ áƒœáƒáƒ‘áƒ˜áƒ¯áƒ”áƒ‘áƒ˜: 1) áƒ¨áƒ”áƒáƒ›áƒáƒ¬áƒ›áƒ” áƒ™áƒ•áƒ”áƒ‘áƒ/áƒ›áƒ˜áƒ¬áƒ; 2) áƒáƒ¡áƒªáƒ˜áƒšáƒáƒ¡áƒ™áƒáƒáƒ˜áƒ— áƒ¡áƒ˜áƒ’áƒœáƒáƒšáƒ˜; 3) áƒ™áƒáƒœáƒ”áƒ¥áƒ¢áƒáƒ áƒ˜áƒ¡ áƒ™áƒáƒ áƒáƒ–áƒ˜áƒ; 4) áƒ¡áƒáƒ­áƒ˜áƒ áƒáƒ”áƒ‘áƒ˜áƒ¡ áƒ¨áƒ”áƒ›áƒ—áƒ®áƒ•áƒ”áƒ•áƒáƒ¨áƒ˜ áƒáƒ áƒáƒ’áƒ áƒáƒ›áƒ£áƒšáƒ˜ áƒ áƒ”áƒ¡áƒ¢áƒáƒ áƒ¢áƒ˜.`;

  // 2) Keyword to KB
  const hit = kb.find(k => q.includes((k.tag||"").toLowerCase())) || kb.find(k => q.includes(k.title.split(" ")[0].toLowerCase()));
  if (hit) return `ğŸ“˜ ${hit.title}\n\n${hit.body}`;

  // 3) Generic diagnostic tree
  return `áƒ«áƒ›áƒáƒ‘áƒ˜áƒšáƒ, áƒ“áƒáƒ•áƒ˜áƒ¬áƒ§áƒáƒ— áƒ¡áƒ¬áƒ áƒáƒ¤áƒ˜ áƒ“áƒ˜áƒáƒ’áƒœáƒáƒ¡áƒ¢áƒ˜áƒ™áƒ˜áƒ—:\n\n1) áƒ¡áƒ˜áƒ›áƒáƒ¢áƒáƒ›áƒ˜áƒ¡ áƒ¢áƒ˜áƒáƒ˜: áƒ’áƒáƒ©áƒ”áƒ áƒ”áƒ‘áƒáƒ–áƒ”/áƒ›áƒáƒ«áƒ áƒáƒáƒ‘áƒáƒ–áƒ”/áƒªáƒ˜áƒ•áƒ–áƒ”/áƒªáƒ®áƒ”áƒšáƒ–áƒ”?\n2) MIL áƒ“áƒ áƒ™áƒáƒ“áƒ”áƒ‘áƒ˜: áƒ áƒ áƒ™áƒáƒ“áƒ”áƒ‘áƒ˜áƒ? Freeze Frame áƒœáƒáƒ®áƒ”.\n3) áƒ™áƒ•áƒ”áƒ‘áƒ/áƒ›áƒ˜áƒ¬áƒ: áƒ¤áƒ˜áƒ£áƒ–áƒ”áƒ‘áƒ˜/áƒ áƒ”áƒšáƒ”áƒ”áƒ‘áƒ˜, áƒ›áƒ˜áƒ¬áƒ˜áƒ¡ áƒ¬áƒ”áƒ áƒ¢áƒ˜áƒšáƒ”áƒ‘áƒ˜.\n4) áƒ¡áƒ”áƒœáƒ¡áƒáƒ áƒ”áƒ‘áƒ˜: LiveData â€” áƒ áƒ áƒ¨áƒ áƒ”áƒ‘áƒ/áƒ áƒ˜áƒ¡áƒ™áƒ“áƒ”áƒ‘áƒ áƒ›áƒáƒ•áƒšáƒ”áƒœáƒáƒ›áƒ“áƒ”?\n5) áƒ°áƒ”áƒ áƒ›áƒ”áƒ¢áƒ£áƒšáƒáƒ‘áƒ: áƒ•áƒáƒ™áƒ£áƒ£áƒ›áƒ˜, áƒ°áƒáƒ”áƒ áƒ˜áƒ¡/áƒ’áƒáƒ›áƒáƒœáƒáƒ‘áƒáƒšáƒ¥áƒ•áƒ˜áƒ¡ áƒ’áƒáƒŸáƒáƒœáƒ•áƒ.\n6) áƒ¢áƒ”áƒ¡áƒ¢áƒ˜áƒ áƒ”áƒ‘áƒ: áƒáƒ¡áƒªáƒ˜áƒšáƒáƒ¡áƒ™áƒáƒáƒ˜, áƒáƒ¥áƒ¢áƒ˜áƒ•áƒáƒªáƒ˜áƒ”áƒ‘áƒ˜ (actuator test).\n\náƒ—áƒ£ áƒ’áƒ˜áƒœáƒ“áƒ, áƒ©áƒáƒ›áƒ˜áƒ¬áƒ”áƒ áƒ” áƒ™áƒáƒ“áƒ”áƒ‘áƒ˜ áƒ“áƒ LiveData â€” áƒ”áƒ áƒ—áƒáƒ“ áƒ›áƒáƒ•áƒ­áƒ˜áƒ“áƒ”áƒ‘áƒ—.`;
}

// Sidebar button component
function SideBtn({ icon: Icon, label, onClick }: { icon: any; label: string; onClick?: () => void }) {
  return (
    <Button variant="ghost" className="w-full justify-start gap-2 rounded-xl" onClick={onClick}>
      <Icon className="h-4 w-4" /> {label}
    </Button>
  );
}

// Tag pill
function Tag({ children }: { children: React.ReactNode }) {
  return <span className="text-xs px-2 py-1 rounded-full bg-muted/60">{children}</span>;
}

export default function GogaAIApp() {
  const [messages, setMessages] = useState<ChatMessage[]>([
    { role: "assistant", time: now(), text: "áƒ’áƒáƒ›áƒáƒ áƒ¯áƒáƒ‘áƒ áƒ«áƒ›áƒáƒ‘áƒ˜áƒšáƒ! áƒ›áƒ” áƒ•áƒáƒ  GogaAI â€” áƒ›áƒ”áƒ¥áƒáƒœáƒ˜áƒ™áƒáƒ¡áƒ˜áƒ¡ áƒáƒ¡áƒ˜áƒ¡áƒ¢áƒ”áƒœáƒ¢áƒ˜. áƒ áƒ áƒ¨áƒ”áƒ’áƒáƒ¬áƒ£áƒ®áƒ“áƒ? ğŸ˜Š" },
  ]);
  const [input, setInput] = useState("");
  const [knowledge, setKnowledge] = useState<KnowledgeItem[]>(DEFAULT_KNOWLEDGE);
  const [filter, setFilter] = useState("");
  const [dtc, setDtc] = useState("");
  const [dtcNotes, setDtcNotes] = useState<string[]>([]);
  const endRef = useRef<HTMLDivElement>(null);

  useEffect(() => { endRef.current?.scrollIntoView({ behavior: "smooth" }); }, [messages.length]);

  const filteredKB = useMemo(() => {
    const f = filter.trim().toLowerCase();
    if (!f) return knowledge;
    return knowledge.filter(k => (k.title + " " + (k.tag||"") + " " + k.body).toLowerCase().includes(f));
  }, [filter, knowledge]);

  function sendMessage() {
    const text = input.trim();
    if (!text) return;
    const userMsg: ChatMessage = { role: "user", text, time: now() };
    const answer = mockAnswer(text, knowledge);
    const aiMsg: ChatMessage = { role: "assistant", text: answer, time: now() };
    setMessages(m => [...m, userMsg, aiMsg]);
    setInput("");
  }

  function addKnowledgeSample() {
    const id = uid();
    const item: KnowledgeItem = {
      id,
      tag: "EEPROM",
      title: "EEPROM dump áƒ¨áƒ”áƒ“áƒáƒ áƒ”áƒ‘áƒ â€” EWS/DME áƒ¡áƒ˜áƒœáƒ¥áƒ áƒ",
      body: `
BMW E90 EWS3 <-> DME sync: áƒ¬áƒáƒ˜áƒ™áƒ˜áƒ—áƒ®áƒ” áƒáƒ áƒ˜áƒ•áƒ” dump, áƒ¨áƒ”áƒáƒ“áƒáƒ áƒ” ISN/KEY áƒ‘áƒáƒ˜áƒ¢áƒ”áƒ‘áƒ˜. áƒ—áƒ£ mismatch: 
â€¢ áƒ’áƒáƒáƒ™áƒ”áƒ—áƒ” virgin DME áƒáƒœ EWS; 
â€¢ áƒ©áƒáƒ¬áƒ”áƒ áƒ” áƒ¡áƒ¬áƒáƒ áƒ˜ ISN; 
â€¢ áƒ¨áƒ”áƒáƒ›áƒáƒ¬áƒ›áƒ” CAS/EWS power & ground.\náƒ™áƒáƒ›áƒ”áƒœáƒ¢áƒáƒ áƒ˜: áƒ“áƒ”áƒœáƒ˜áƒ¡ áƒ•áƒáƒ áƒ“áƒœáƒ˜áƒ¡áƒáƒ¡ áƒ®áƒ¨áƒ˜áƒ áƒáƒ“ áƒ˜áƒ áƒ¦áƒ•áƒ”áƒ•áƒ áƒ¡áƒ˜áƒœáƒ¥áƒ áƒ.`
    };
    setKnowledge(k => [item, ...k]);
    toast.success("áƒ“áƒáƒ”áƒ›áƒáƒ¢áƒ EEPROM áƒ¡áƒáƒ®áƒ”áƒšáƒ›áƒ«áƒ¦áƒ•áƒáƒœáƒ”áƒšáƒ");
  }

  function removeKB(id: string) {
    setKnowledge(k => k.filter(i => i.id !== id));
  }

  function onDtcAdd() {
    const c = dtc.trim().toUpperCase();
    if (!c) return;
    const base = DTC_HINTS[c] || "áƒ”áƒ¡ áƒ™áƒáƒ“áƒ˜ áƒ‘áƒáƒ–áƒáƒ¨áƒ˜ áƒáƒ  áƒáƒ áƒ˜áƒ¡ â€” áƒ“áƒáƒáƒ›áƒáƒ¢áƒ” áƒ¨áƒ”áƒœáƒ¡ áƒªáƒáƒ“áƒœáƒáƒ¨áƒ˜ áƒ“áƒ áƒ¨áƒ”áƒ˜áƒœáƒáƒ®áƒ” áƒ¨áƒ”áƒœáƒ¡ áƒ¡áƒ¢áƒ˜áƒšáƒ¨áƒ˜.";
    setDtcNotes(n => [`${c}: ${base}`, ...n]);
    setDtc("");
  }

  return (
    <div className="min-h-[100vh] w-full bg-gradient-to-br from-neutral-50 to-neutral-100">
      {/* Top bar */}
      <div className="sticky top-0 z-30 backdrop-blur bg-white/70 border-b">
        <div className="container mx-auto p-3 flex items-center gap-3">
          <motion.div initial={{ scale: 0.9, opacity: 0 }} animate={{ scale: 1, opacity: 1 }} className="flex items-center gap-2">
            <div className="p-2 rounded-2xl bg-black text-white"><Bot className="h-5 w-5" /></div>
            <div className="leading-tight">
              <div className="font-bold text-lg">GogaAI</div>
              <div className="text-xs text-muted-foreground">áƒ›áƒ”áƒ¥áƒáƒœáƒ˜áƒ™áƒáƒ¡áƒ˜áƒ¡ áƒáƒ¡áƒ˜áƒ¡áƒ¢áƒ”áƒœáƒ¢áƒ˜ â€¢ ECU â€¢ ESL â€¢ EEPROM â€¢ CAN</div>
            </div>
          </motion.div>
          <div className="ml-auto flex items-center gap-2">
            <Badge className="rounded-xl" variant="secondary"><Shield className="h-3 w-3 mr-1"/>Pro-áƒ›áƒáƒ“áƒ£áƒšáƒ˜ áƒ¨áƒ”áƒ£áƒ¤áƒ”áƒ áƒ®áƒ”áƒ‘áƒšáƒáƒ“</Badge>
            <Dialog>
              <DialogTrigger asChild>
                <Button size="sm" className="rounded-xl"><CloudUpload className="h-4 w-4 mr-1"/>áƒ‘áƒáƒ–áƒ˜áƒ¡ áƒ˜áƒ›áƒáƒáƒ áƒ¢áƒ˜</Button>
              </DialogTrigger>
              <DialogContent className="sm:max-w-xl">
                <DialogHeader>
                  <DialogTitle>áƒ¨áƒ”áƒœáƒ˜áƒ¡ áƒªáƒáƒ“áƒœáƒ˜áƒ¡ áƒ˜áƒ›áƒáƒáƒ áƒ¢áƒ˜ (TXT/MD)</DialogTitle>
                </DialogHeader>
                <div className="space-y-3">
                  <p className="text-sm text-muted-foreground">áƒ©áƒáƒáƒ’áƒ“áƒ” áƒ¨áƒ”áƒœáƒ¡ áƒ›áƒ˜áƒ”áƒ  áƒ“áƒáƒ¬áƒ”áƒ áƒ˜áƒšáƒ˜ áƒ’áƒ–áƒáƒ›áƒ™áƒ•áƒšáƒ”áƒ•áƒ”áƒ‘áƒ˜, áƒ™áƒ”áƒ˜áƒ¡áƒ”áƒ‘áƒ˜, DTC áƒáƒ®áƒ¡áƒœáƒ. áƒ¤áƒáƒ˜áƒšáƒ”áƒ‘áƒ˜ áƒáƒ  áƒ˜áƒ’áƒ–áƒáƒ•áƒœáƒ”áƒ‘áƒ áƒ¡áƒ”áƒ áƒ•áƒ”áƒ áƒ–áƒ” áƒáƒ› MVP-áƒ¨áƒ˜ â€” áƒ˜áƒœáƒáƒ®áƒ”áƒ‘áƒ áƒ‘áƒ áƒáƒ£áƒ–áƒ”áƒ áƒ¨áƒ˜.</p>
                  <Input type="file" multiple onChange={(e) => {
                    const files = Array.from(e.target.files || []);
                    files.forEach(async (f) => {
                      const text = await f.text();
                      setKnowledge(k => [{ id: uid(), title: f.name, body: text }, ...k]);
                    });
                    toast.success("áƒ¤áƒáƒ˜áƒšáƒ”áƒ‘áƒ˜ áƒ“áƒáƒ”áƒ›áƒáƒ¢áƒ áƒªáƒáƒ“áƒœáƒ˜áƒ¡ áƒ‘áƒáƒ–áƒáƒ¡");
                  }}/>
                </div>
              </DialogContent>
            </Dialog>
          </div>
        </div>
      </div>

      <div className="container mx-auto grid grid-cols-1 md:grid-cols-12 gap-4 p-4">
        {/* Sidebar */}
        <aside className="md:col-span-3 space-y-3">
          <Card className="rounded-2xl">
            <CardHeader className="pb-2"><CardTitle className="text-base flex items-center gap-2"><Wrench className="h-4 w-4"/>áƒ¡áƒáƒ›áƒ£áƒ¨áƒáƒ áƒáƒáƒœáƒ”áƒšáƒ˜</CardTitle></CardHeader>
            <CardContent className="grid gap-1">
              <SideBtn icon={Search} label="áƒ¡áƒ¬áƒ áƒáƒ¤áƒ˜ áƒ“áƒ˜áƒáƒ’áƒœáƒáƒ¡áƒ¢áƒ˜áƒ™áƒ" onClick={() => setMessages(m => [...m, { role: "assistant", time: now(), text: "áƒáƒ˜ áƒ¡áƒ¬áƒ áƒáƒ¤áƒ˜ áƒ©áƒ”áƒ™áƒšáƒ˜áƒ¡áƒ¢áƒ˜: 1) áƒ¡áƒ˜áƒ›áƒáƒ¢áƒáƒ›áƒ˜ 2) áƒ™áƒáƒ“áƒ”áƒ‘áƒ˜ 3) áƒ™áƒ•áƒ”áƒ‘áƒ/áƒ›áƒ˜áƒ¬áƒ 4) LiveData 5) áƒ°áƒ”áƒ áƒ›áƒ”áƒ¢áƒ£áƒšáƒáƒ‘áƒ 6) áƒáƒ¥áƒ¢áƒ˜áƒ•áƒáƒªáƒ˜áƒ”áƒ‘áƒ˜" }])}/>
              <SideBtn icon={CircuitBoard} label="ECU / Pinout áƒ áƒ©áƒ”áƒ•áƒ”áƒ‘áƒ˜" onClick={addKnowledgeSample}/>
              <SideBtn icon={Key} label="Immobilizer & ESL" onClick={() => setFilter("EEPROM")}/>
              <SideBtn icon={Database} label="EEPROM Helper" onClick={() => toast.message("EEPROM áƒ›áƒáƒ“áƒ£áƒšáƒ˜ (MVP) â€” áƒ“áƒáƒáƒ›áƒáƒ¢áƒ” áƒ¨áƒ”áƒœáƒ˜ dump-áƒ”áƒ‘áƒ˜ áƒªáƒáƒ“áƒœáƒ˜áƒ¡ áƒ‘áƒáƒ–áƒáƒ¨áƒ˜.")}/>
              <SideBtn icon={FileText} label="áƒ¥áƒ”áƒ˜áƒ¡áƒ”áƒ‘áƒ˜áƒ¡ áƒáƒ áƒ¥áƒ˜áƒ•áƒ˜" onClick={() => setFilter("")}/>
              <SideBtn icon={Settings} label="áƒáƒáƒ áƒáƒ›áƒ”áƒ¢áƒ áƒ”áƒ‘áƒ˜" onClick={() => toast.info("áƒáƒáƒ áƒáƒ›áƒ”áƒ¢áƒ áƒ”áƒ‘áƒ˜ áƒ“áƒáƒ”áƒ›áƒáƒ¢áƒ”áƒ‘áƒ Pro áƒ•áƒ”áƒ áƒ¡áƒ˜áƒáƒ¨áƒ˜")}/>
            </CardContent>
          </Card>

          <Card className="rounded-2xl">
            <CardHeader className="pb-2"><CardTitle className="text-base flex items-center gap-2"><Gauge className="h-4 w-4"/>DTC áƒ¥áƒ•áƒ”-áƒ’áƒ˜áƒ“áƒ˜</CardTitle></CardHeader>
            <CardContent className="space-y-2">
              <div className="flex gap-2">
                <Input placeholder="áƒ›áƒáƒ’: P0299" value={dtc} onChange={(e) => setDtc(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && onDtcAdd()} />
                <Button onClick={onDtcAdd} className="rounded-xl"><PlusCircle className="h-4 w-4"/></Button>
              </div>
              <div className="space-y-2 max-h-52 overflow-auto pr-1">
                {dtcNotes.length === 0 && (
                  <p className="text-xs text-muted-foreground">áƒ©áƒáƒ¬áƒ”áƒ áƒ” áƒ™áƒáƒ“áƒ˜ áƒ“áƒ áƒ›áƒ˜áƒ˜áƒ¦áƒ” áƒ¡áƒ¬áƒ áƒáƒ¤áƒ˜ áƒ›áƒ˜áƒœáƒ˜áƒ¨áƒœáƒ”áƒ‘áƒ”áƒ‘áƒ˜. áƒ¨áƒ”áƒœáƒ˜áƒ¨áƒ•áƒœáƒ”áƒ‘áƒ˜ áƒ¨áƒ”áƒ˜áƒœáƒáƒ®áƒ”áƒ‘áƒ áƒ¡áƒ”áƒ¡áƒ˜áƒ˜áƒ¡ áƒ¤áƒáƒ áƒ’áƒšáƒ”áƒ‘áƒ¨áƒ˜.</p>
                )}
                {dtcNotes.map((n, i) => (
                  <div key={i} className="text-xs p-2 bg-muted/50 rounded-xl flex items-start gap-2">
                    <Badge variant="secondary" className="rounded-lg mt-0.5">DTC</Badge>
                    <span className="leading-snug whitespace-pre-wrap">{n}</span>
                  </div>
                ))}
              </div>
            </CardContent>
          </Card>

          <Card className="rounded-2xl">
            <CardHeader className="pb-2"><CardTitle className="text-base flex items-center gap-2"><BookOpen className="h-4 w-4"/>áƒªáƒáƒ“áƒœáƒ˜áƒ¡ áƒ‘áƒáƒ–áƒ</CardTitle></CardHeader>
            <CardContent className="space-y-2">
              <Input placeholder="áƒ«áƒ”áƒ‘áƒœáƒâ€¦ (áƒ›áƒáƒ“áƒ”áƒšáƒ˜, DTC, áƒ¡áƒ˜áƒ¢áƒ§áƒ•áƒ)" value={filter} onChange={(e) => setFilter(e.target.value)} />
              <div className="space-y-2 max-h-64 overflow-auto pr-1">
                {filteredKB.map((k) => (
                  <div key={k.id} className="p-2 rounded-xl bg-white border flex items-start gap-2">
                    <div className="mt-1"><Info className="h-4 w-4"/></div>
                    <div className="grow">
                      <div className="text-sm font-medium flex items-center gap-2">{k.title} {k.tag && <Tag>{k.tag}</Tag>}</div>
                      <div className="text-xs text-muted-foreground line-clamp-3">{k.body}</div>
                    </div>
                    <Button size="icon" variant="ghost" onClick={() => removeKB(k.id)} className="rounded-xl"><Trash2 className="h-4 w-4"/></Button>
                  </div>
                ))}
                {filteredKB.length === 0 && (
                  <div className="text-xs text-muted-foreground">áƒ•áƒ”áƒ áƒáƒ¤áƒ”áƒ áƒ¡ áƒ•áƒáƒáƒ£áƒšáƒáƒ‘. áƒ¡áƒªáƒáƒ“áƒ” áƒ¡áƒ®áƒ•áƒ áƒ¡áƒ˜áƒ¢áƒ§áƒ•áƒ áƒáƒœ áƒ˜áƒ›áƒáƒáƒ áƒ¢áƒ˜ áƒ–áƒ”áƒ›áƒáƒ—.</div>
                )}
              </div>
            </CardContent>
          </Card>
        </aside>

        {/* Main chat */}
        <main className="md:col-span-9 space-y-3">
          <Card className="rounded-2xl h-[72vh] flex flex-col">
            <CardHeader className="pb-2"><CardTitle className="text-base flex items-center gap-2"><Bot className="h-4 w-4"/>áƒ©áƒáƒ¢áƒ˜ â€¢ GogaAI</CardTitle></CardHeader>
            <CardContent className="flex-1 overflow-auto space-y-3 pr-1">
              {messages.map((m, i) => (
                <div key={i} className={`flex ${m.role === 'assistant' ? 'justify-start' : 'justify-end'}`}>
                  <div className={`max-w-[80%] rounded-2xl px-3 py-2 text-sm leading-relaxed whitespace-pre-wrap shadow-sm ${m.role === 'assistant' ? 'bg-white border' : 'bg-black text-white'}`}>
                    <div className="text-[10px] opacity-60 mb-1">{m.role === 'assistant' ? 'GogaAI' : 'áƒ¨áƒ”áƒœ'} â€¢ {m.time}</div>
                    {m.text}
                  </div>
                </div>
              ))}
              <div ref={endRef} />
            </CardContent>
            <div className="p-3 border-t flex gap-2">
              <Textarea value={input} onChange={(e) => setInput(e.target.value)} placeholder="áƒ›áƒ˜áƒ§áƒ”áƒ•áƒ˜ áƒ¡áƒ˜áƒ›áƒáƒ¢áƒáƒ›áƒ¡ áƒáƒœ DTC-áƒ¡â€¦" className="min-h-[44px] max-h-40" onKeyDown={(e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }}} />
              <Button onClick={sendMessage} className="rounded-2xl px-4"><Send className="h-4 w-4"/></Button>
            </div>
          </Card>

          {/* Onboarding / value props */}
          <Card className="rounded-2xl">
            <CardContent className="p-4 grid md:grid-cols-3 gap-3">
              <div className="p-3 rounded-2xl bg-white border">
                <div className="flex items-center gap-2 font-semibold mb-1"><Sparkles className="h-4 w-4"/>áƒ áƒáƒ¡ áƒáƒ™áƒ”áƒ—áƒ”áƒ‘áƒ¡ GogaAI</div>
                <p className="text-sm text-muted-foreground">áƒ¡áƒ¬áƒ áƒáƒ¤áƒ˜ áƒ“áƒ˜áƒáƒ’áƒœáƒáƒ¡áƒ¢áƒ˜áƒ™áƒ áƒ¨áƒ”áƒœáƒ¡ áƒ¡áƒ¢áƒ˜áƒšáƒ–áƒ”, áƒ áƒ”áƒáƒšáƒ£áƒ áƒ˜ áƒ¥áƒ”áƒ˜áƒ¡áƒ”áƒ‘áƒ˜áƒ—, áƒ¥áƒáƒ áƒ—áƒ£áƒš áƒ”áƒœáƒáƒ–áƒ”. ECU â€¢ ESL â€¢ EEPROM â€¢ CAN.</p>
              </div>
              <div className="p-3 rounded-2xl bg-white border">
                <div className="flex items-center gap-2 font-semibold mb-1"><Lock className="h-4 w-4"/>áƒ¨áƒ”áƒœáƒ˜ áƒªáƒáƒ“áƒœáƒ â€” áƒ¨áƒ”áƒœáƒ˜ áƒ‘áƒ áƒ”áƒœáƒ“áƒ˜</div>
                <p className="text-sm text-muted-foreground">áƒ˜áƒ›áƒáƒáƒ áƒ¢áƒ˜ TXT/MD áƒ¤áƒáƒ˜áƒšáƒ˜áƒ“áƒáƒœ, áƒ¨áƒ”áƒœáƒ¡ áƒ‘áƒáƒ–áƒáƒ“ áƒ˜áƒ¥áƒªáƒ”áƒ•áƒ. áƒáƒ áƒáƒ¤áƒ”áƒ áƒ˜ áƒ˜áƒ’áƒ–áƒáƒ•áƒœáƒ”áƒ‘áƒ áƒ¡áƒ”áƒ áƒ•áƒ”áƒ áƒ–áƒ” áƒáƒ› MVP-áƒ¨áƒ˜.</p>
              </div>
              <div className="p-3 rounded-2xl bg-white border">
                <div className="flex items-center gap-2 font-semibold mb-1"><Zap className="h-4 w-4"/>áƒ¨áƒ”áƒ›áƒ“áƒ”áƒ’áƒ˜ áƒœáƒáƒ‘áƒ˜áƒ¯áƒ”áƒ‘áƒ˜</div>
                <p className="text-sm text-muted-foreground">áƒ“áƒáƒáƒ™áƒáƒ•áƒ¨áƒ˜áƒ áƒ” áƒ áƒ”áƒáƒšáƒ£áƒ  LLM API-áƒ¡, áƒ“áƒáƒáƒ›áƒáƒ¢áƒ” áƒ›áƒáƒ›áƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒšáƒ”áƒ‘áƒ˜áƒ¡ áƒáƒ•áƒ¢áƒáƒ áƒ˜áƒ–áƒáƒªáƒ˜áƒ áƒ“áƒ áƒ¡áƒáƒ¤áƒáƒ¡áƒ áƒ’áƒ”áƒ’áƒ›áƒ (10â€“20 áƒšáƒáƒ áƒ˜/áƒ—áƒ•áƒ”áƒ¨áƒ˜).</p>
              </div>
            </CardContent>
          </Card>
        </main>
      </div>

      <footer className="container mx-auto p-6 text-xs text-muted-foreground flex items-center justify-between">
        <div className="flex items-center gap-2"><Car className="h-3 w-3"/> â€áƒ«áƒ›áƒáƒ‘áƒ˜áƒšáƒâ€œ áƒ áƒ”áƒŸáƒ˜áƒ›áƒ˜ áƒ©áƒáƒ áƒ—áƒ£áƒšáƒ˜áƒ â€¢ Beta</div>
        <div className="flex items-center gap-1">
          <HelpCircle className="h-3 w-3"/> áƒ—áƒ£ áƒ áƒáƒ¦áƒáƒª áƒ’áƒáƒ­áƒ”áƒ“áƒ â€” áƒ“áƒáƒ¬áƒ”áƒ áƒ” "help" áƒ©áƒáƒ¢áƒ¨áƒ˜.
        </div>
      </footer>
    </div>
  );
}
